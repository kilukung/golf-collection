<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Golf Collection List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .bag-card { transition: all 0.3s ease; cursor: pointer;}
    .bag-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .success-message { transform: translateY(-20px); opacity: 0; transition: all 0.5s ease; }
    .success-message.show { transform: translateY(0); opacity: 1; }
    .bag-image { width: 100%; height: 100%; object-fit: contain; }
    .image-container { background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="transition-colors duration-500">

<div class="container mx-auto px-4 py-8 max-w-6xl">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Golf Collection List</h1>
    <button id="undoBtn" class="px-4 py-2 bg-red-500 text-white rounded hidden">Undo</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <!-- cards generate by JS -->
  </div>

  <!-- Form -->
  <form id="collectionForm" class="bg-white p-6 rounded shadow-md mb-10">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <input type="date" id="date" class="border p-2 rounded" required>
      <input type="text" id="name" class="border p-2 rounded" placeholder="Name" required>
      <input type="tel" id="telephone" class="border p-2 rounded" placeholder="Telephone" required>
      <input type="text" id="signature" class="border p-2 rounded" placeholder="Signature" required>
    </div>
    <p class="text-gray-600 mb-2">Tip: Click on a card above to select bags</p>
    <button class="px-6 py-2 bg-blue-600 text-white rounded">Submit</button>
  </form>

  <!-- Records -->
  <table class="min-w-full bg-white rounded shadow-md">
    <thead><tr class="bg-gray-100">
      <th class="p-2 text-left">Date</th>
      <th class="p-2 text-left">Name</th>
      <th class="p-2 text-left">Telephone</th>
      <th class="p-2 text-left">Bags</th>
      <th class="p-2 text-left">Signature</th>
    </tr></thead>
    <tbody id="recordsTableBody"></tbody>
  </table>
</div>

<div id="successMessage" class="success-message fixed top-4 right-4 bg-green-100 p-4 rounded shadow">Saved!</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, getDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCDG0_qs4g4ajpoqAgSYCf_NKNwbFogQEQ",
  authDomain: "golf-collection-list.firebaseapp.com",
  projectId: "golf-collection-list",
  storageBucket: "golf-collection-list.appspot.com",
  messagingSenderId: "119781201406",
  appId: "1:119781201406:web:43499800e32cc9c5b25caf",
  measurementId: "G-E396QPZBG6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const dashboard = document.getElementById("dashboard");
const form = document.getElementById("collectionForm");
const tableBody = document.getElementById("recordsTableBody");
const successMessage = document.getElementById("successMessage");
const undoBtn = document.getElementById("undoBtn");

// bag list
const bagList = {
  "ptt-2024": {name:"2024 – PTT NGD", total:10, img:"https://i.ibb.co/HD0PLqk5/thumbnail-IMG-8849.jpg"},
  "amata-2024": {name:"2024 – AMATA NGD", total:8, img:"https://i.ibb.co/jBfdyYY/thumbnail-IMG-8850.jpg"},
  "ptt-2025": {name:"2025 – PTT NGD", total:7, img:"https://i.ibb.co/qFr04hHx/thumbnail-IMG-8851.jpg"},
  "amata-2025": {name:"2025 – AMATA NGD", total:7, img:"https://i.ibb.co/Q3nKbZqY/thumbnail-IMG-8848.jpg"}
};
let selectedBags=[];
let lastAction=null;

// set today default
document.getElementById("date").value = new Date().toISOString().split("T")[0];

// show success
function showSuccess(msg="Saved!") {
  successMessage.textContent = msg;
  successMessage.classList.add("show");
  setTimeout(()=>successMessage.classList.remove("show"),2000);
}

// update dashboard
function renderDashboard(data){
  dashboard.innerHTML="";
  for(const [key,info] of Object.entries(bagList)){
    const inv = data[key] || {total:info.total,used:0,remaining:info.total};
    const isSelected = selectedBags.includes(key);
    dashboard.innerHTML+=`
    <div data-key="${key}" class="bag-card bg-white rounded-lg shadow-md overflow-hidden border-4 ${isSelected?'border-blue-500':'border-transparent'}">
      <div class="image-container h-64"><img src="${info.img}" class="bag-image"></div>
      <div class="p-4">
        <h3 class="font-semibold">${info.name}</h3>
        <p>Total: ${inv.total}</p>
        <p>Used: ${inv.used}</p>
        <p class="text-blue-600">Remaining: ${inv.remaining}</p>
      </div>
    </div>`;
  }
  document.querySelectorAll(".bag-card").forEach(card=>{
    card.addEventListener("click",()=>{
      const key = card.dataset.key;
      if(selectedBags.includes(key)){
        selectedBags = selectedBags.filter(k=>k!==key);
      } else {
        selectedBags.push(key);
      }
      renderDashboard(latestInventory);
    });
  });
}

// load records
async function loadRecords(){
  tableBody.innerHTML="";
  const snapshot = await getDocs(collection(db,"collections"));
  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const row = `<tr>
      <td class="p-2">${d.date}</td>
      <td class="p-2">${d.name}</td>
      <td class="p-2">${d.telephone}</td>
      <td class="p-2">${(d.bags||[]).map(b=>bagList[b]?.name||b).join(", ")}</td>
      <td class="p-2">${d.signature}</td>
    </tr>`;
    tableBody.innerHTML += row;
  });
}

let latestInventory={};
onSnapshot(collection(db,"inventory"),(snapshot)=>{
  let data={};
  snapshot.forEach(docSnap=>data[docSnap.id]=docSnap.data());
  latestInventory=data;
  renderDashboard(data);
});

// submit
form.addEventListener("submit",async(e)=>{
  e.preventDefault();
  const date=document.getElementById("date").value;
  const name=document.getElementById("name").value;
  const telephone=document.getElementById("telephone").value;
  const signature=document.getElementById("signature").value;

  if(selectedBags.length===0){ alert("Please select at least one bag"); return; }

  for(let key of selectedBags){
    const invRef=doc(db,"inventory",key);
    const snap=await getDoc(invRef);
    const inv=snap.data();
    await setDoc(invRef,{...inv,used:inv.used+1,remaining:inv.remaining-1});
  }

  const docRef = await addDoc(collection(db,"collections"),{
    date,name,telephone,signature,bags:selectedBags
  });

  lastAction = { selected:[...selectedBags], recordId: docRef.id };
  undoBtn.classList.remove("hidden");

  form.reset();
  selectedBags=[];
  showSuccess();
  loadRecords();
});

// undo
undoBtn.addEventListener("click",async()=>{
  if(!lastAction)return;
  for(let key of lastAction.selected){
    const invRef=doc(db,"inventory",key);
    const snap=await getDoc(invRef);
    const inv=snap.data();
    await setDoc(invRef,{...inv,used:inv.used-1,remaining:inv.remaining+1});
  }
  if (lastAction.recordId) {
    await deleteDoc(doc(db,"collections",lastAction.recordId));
  }
  lastAction=null;
  undoBtn.classList.add("hidden");
  showSuccess("Undo complete");
  loadRecords();
});

loadRecords();
</script>
</body>
</html>
