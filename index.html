<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golf Collection List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; transition: background 0.3s, color 0.3s; }
    .bag-card { transition: all 0.3s ease; cursor: pointer; }
    .bag-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .success-message { transform: translateY(-20px); opacity: 0; transition: all 0.5s ease; }
    .success-message.show { transform: translateY(0); opacity: 1; }
    .dark body { background-color:#0f172a; color:#f8fafc; }
  </style>
</head>
<body class="bg-sky-50 text-gray-800">
<div class="container mx-auto px-4 py-6 max-w-6xl">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Golf Collection</h1>
    <div class="space-x-3">
      <button id="darkToggle" class="px-4 py-2 bg-gray-800 text-white rounded">Dark</button>
      <button id="undoBtn" class="hidden px-4 py-2 bg-red-600 text-white rounded">Undo</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>

  <!-- Form -->
  <form id="collectionForm" class="bg-white p-6 rounded shadow-md mb-8 dark:bg-slate-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <input type="date" id="date" class="border p-2 rounded text-gray-700" required>
      <input type="text" id="name" class="border p-2 rounded text-gray-700" placeholder="Name" required>
      <input type="tel" id="telephone" class="border p-2 rounded text-gray-700" placeholder="Telephone" required>
      <input type="text" id="signature" class="border p-2 rounded text-gray-700" placeholder="Signature" required>
    </div>
    <button class="px-6 py-2 bg-blue-600 text-white rounded">Submit</button>
  </form>

  <!-- Records -->
  <table class="min-w-full bg-white rounded shadow-md dark:bg-slate-700">
    <thead><tr class="bg-blue-100 dark:bg-slate-600">
      <th class="p-2 text-left">Date</th>
      <th class="p-2 text-left">Name</th>
      <th class="p-2 text-left">Telephone</th>
      <th class="p-2 text-left">Bags</th>
      <th class="p-2 text-left">Signature</th>
    </tr></thead>
    <tbody id="recordsTableBody"></tbody>
  </table>
</div>

<div id="successMessage" class="success-message fixed top-4 right-4 bg-green-100 p-4 rounded shadow">Saved!</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, getDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDG0_qs4g4ajpoqAgSYCf_NKNwbFogQEQ",
  authDomain: "golf-collection-list.firebaseapp.com",
  projectId: "golf-collection-list",
  storageBucket: "golf-collection-list.appspot.com",
  messagingSenderId: "119781201406",
  appId: "1:119781201406:web:43499800e32cc9c5b25caf",
  measurementId: "G-E396QPZBG6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const dashboard = document.getElementById("dashboard");
const tableBody = document.getElementById("recordsTableBody");
const successMessage = document.getElementById("successMessage");
const undoBtn = document.getElementById("undoBtn");
const darkToggle = document.getElementById("darkToggle");
let lastAction = null;

// toggle dark
darkToggle.addEventListener("click", () => document.documentElement.classList.toggle("dark"));

// show success
function showSuccess(msg) {
  successMessage.textContent = msg;
  successMessage.classList.add("show");
  setTimeout(()=>successMessage.classList.remove("show"),2000);
}

// render dashboard
function renderDashboard(data) {
  dashboard.innerHTML = "";
  Object.entries(data).forEach(([key,val])=>{
    const percent = (val.remaining/val.total)*100;
    dashboard.innerHTML += `
      <div class="bag-card bg-white rounded-lg shadow-md overflow-hidden dark:bg-slate-700" data-key="${key}">
        <div class="h-48 flex items-center justify-center bg-sky-100"><img src="${val.img}" class="h-full object-contain"></div>
        <div class="p-4">
          <h3 class="font-semibold mb-2">${val.label}</h3>
          <div class="w-full bg-sky-200 rounded-full h-3 mb-2">
            <div class="bg-blue-500 h-3 rounded-full" style="width:${percent}%"></div>
          </div>
          <p><b>${val.remaining}</b> / ${val.total} Remaining</p>
        </div>
      </div>`;
  });
  document.querySelectorAll(".bag-card").forEach(card=>{
    card.addEventListener("click",()=>selectBag(card.dataset.key));
  });
}

// select bag from dashboard
async function selectBag(key) {
  const snap = await getDoc(doc(db,"inventory",key));
  if (!snap.exists()) return;
  const inv = snap.data();
  if (inv.remaining<=0) { alert("Out of stock"); return; }
  // mark selection
  form.selectedBags = form.selectedBags || [];
  if (!form.selectedBags.includes(key)) {
    form.selectedBags.push(key);
    showSuccess(`Selected: ${inv.label}`);
  }
}

// live dashboard
onSnapshot(collection(db,"inventory"),(snap)=>{
  const data={};
  snap.forEach(doc=>{
    data[doc.id]=doc.data();
  });
  renderDashboard(data);
});

// load records
async function loadRecords(){
  const snap = await getDocs(collection(db,"collections"));
  tableBody.innerHTML="";
  snap.forEach(d=>{
    const x=d.data();
    tableBody.innerHTML += `<tr>
      <td class="p-2">${x.date}</td>
      <td class="p-2">${x.name}</td>
      <td class="p-2">${x.telephone}</td>
      <td class="p-2">${(x.bags||[]).join(", ")}</td>
      <td class="p-2">${x.signature}</td></tr>`;
  });
}
loadRecords();

// submit
const form = document.getElementById("collectionForm");
form.addEventListener("submit",async e=>{
  e.preventDefault();
  const date=document.getElementById("date").value;
  const name=document.getElementById("name").value;
  const telephone=document.getElementById("telephone").value;
  const signature=document.getElementById("signature").value;
  const selected=form.selectedBags||[];
  if(selected.length===0){alert("Please select a bag from dashboard!");return;}
  // update stock
  for(let key of selected){
    const invRef=doc(db,"inventory",key);
    const snap=await getDoc(invRef);
    const inv=snap.data();
    await setDoc(invRef,{...inv,used:inv.used+1,remaining:inv.remaining-1});
  }
  // add record
  const docRef = await addDoc(collection(db,"collections"),{date,name,telephone,signature,bags:selected});
  lastAction={selected:[...selected], recordId:docRef.id};
  undoBtn.classList.remove("hidden");
  showSuccess("Saved!");
  form.reset();
  form.selectedBags=[];
  loadRecords();
});

// undo
undoBtn.addEventListener("click",async()=>{
  if(!lastAction)return;
  for(let key of lastAction.selected){
    const invRef=doc(db,"inventory",key);
    const snap=await getDoc(invRef);
    const inv=snap.data();
    await setDoc(invRef,{...inv,used:inv.used-1,remaining:inv.remaining+1});
  }
  if(lastAction.recordId){
    await deleteDoc(doc(db,"collections",lastAction.recordId));
  }
  lastAction=null;
  undoBtn.classList.add("hidden");
  loadRecords();
});
</script>
</body>
</html>
