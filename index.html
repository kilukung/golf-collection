<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Golf Collection List</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">

// ---- Firebase ----
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Config
const firebaseConfig = {
  apiKey: "AIzaSyCDG0_qs4g4ajpoqAgSYCf_NKNwbFogQEQ",
  authDomain: "golf-collection-list.firebaseapp.com",
  projectId: "golf-collection-list",
  storageBucket: "golf-collection-list.appspot.com",
  messagingSenderId: "119781201406",
  appId: "1:119781201406:web:43499800e32cc9c5b25caf",
  measurementId: "G-E396QPZBG6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// HTML refs
const tableBody = document.getElementById("recordsTableBody");
const successMessage = document.getElementById("successMessage");
const form = document.getElementById("collectionForm");
const nameInput = document.getElementById("name");
const telInput = document.getElementById("telephone");
const sigInput = document.getElementById("signature");
const dateInput = document.getElementById("date");

// ฟังก์ชันโชว์ Records
async function loadRecords() {
  tableBody.innerHTML = "";
  const snapshot = await getDocs(collection(db, "collections"));
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    tableBody.innerHTML += `<tr class="hover:bg-gray-50">
      <td class="p-2">${d.date}</td>
      <td class="p-2">${d.name}</td>
      <td class="p-2">${d.telephone}</td>
      <td class="p-2">${(d.bags || []).join(", ")}</td>
      <td class="p-2">${d.signature}</td>
    </tr>`;
  });
}

// Update Dashboard real-time
onSnapshot(collection(db, "inventory"), (snap) => {
  snap.forEach(docSnap => {
    const bag = docSnap.id;
    const data = docSnap.data();
    const total = data.total;
    const used = data.used;
    const remain = total - used;

    document.getElementById(`${bag}-total`).textContent = total;
    document.getElementById(`${bag}-used`).textContent = used;
    document.getElementById(`${bag}-remaining`).textContent = remain;

    const bar = document.getElementById(`${bag}-bar`);
    bar.style.width = `${(remain/total)*100}%`;
  });
});

// เมื่อกดการ์ด
async function handleCardClick(bagId) {
  const name = nameInput.value.trim();
  const tel = telInput.value.trim();
  const sig = sigInput.value.trim();
  const date = dateInput.value;
  if (!name || !tel || !sig) {
    alert("กรอกชื่อ โทรศัพท์ และผู้รับก่อน");
    return;
  }
  const confirmPick = confirm(`ยืนยันรับถุงรุ่น ${bagId}?`);
  if (!confirmPick) return;

  // อัปเดต Firestore: เพิ่ม Record และลด Remaining
  const invRef = doc(db, "inventory", bagId);
  const snap = await getDocs(collection(db,"inventory"));
  let remainOk = true;

  // ดึงค่าปัจจุบัน
  const bagSnap = (await getDocs(collection(db,"inventory")))
    .docs.find(d=>d.id===bagId);

  const cur = bagSnap.data();
  if (cur.used >= cur.total) {
    alert("Stock หมดแล้ว");
    return;
  }

  // update inventory
  await updateDoc(invRef, { used: cur.used + 1 });

  // add record
  await addDoc(collection(db, "collections"), {
    date,
    name,
    telephone: tel,
    signature: sig,
    bags: [bagId]
  });

  successMessage.classList.add("show");
  setTimeout(() => successMessage.classList.remove("show"), 2000);
  loadRecords();
}

window.handleCardClick = handleCardClick;
loadRecords();
</script>

<style>
body { font-family: 'Inter', sans-serif; background-color: #f0f8ff; }
.bag-card { transition: transform 0.3s; cursor: pointer; }
.bag-card:hover { transform: scale(1.05); }
.success-message { opacity: 0; transition: 0.5s; }
.success-message.show { opacity: 1; }
.progress-container {
  background: #dbeafe; height: 8px; border-radius: 4px; overflow: hidden;
}
.progress-bar { background: #2563eb; height: 100%; transition: width 0.3s; }
</style>
</head>

<body>
<div class="container mx-auto p-6 max-w-6xl">
<h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Golf Collection List</h1>

<!-- Form (no bag select) -->
<form id="collectionForm" class="bg-white p-4 rounded shadow mb-8">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <input type="date" id="date" class="border p-2 rounded" required>
    <input type="text" id="name" class="border p-2 rounded" placeholder="Name" required>
    <input type="tel" id="telephone" class="border p-2 rounded" placeholder="Telephone" required>
    <input type="text" id="signature" class="border p-2 rounded" placeholder="Signature" required>
  </div>
  <p class="text-gray-600">เลือกถุงโดยคลิกที่ภาพด้านล่าง</p>
</form>

<!-- Dashboard -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
  <!-- Card template -->
  <div onclick="handleCardClick('ptt-2024')" class="bag-card bg-white rounded-lg shadow-md overflow-hidden">
    <img src="https://i.ibb.co/HD0PLqk5/thumbnail-IMG-8849.jpg" class="h-64 w-full object-contain bg-blue-50">
    <div class="p-4">
      <h3 class="font-semibold text-blue-700">2024 – PTT NGD</h3>
      <div class="progress-container mt-2"><div id="ptt-2024-bar" class="progress-bar w-full"></div></div>
      <p class="mt-2 text-sm">Remaining: <span id="ptt-2024-remaining">0</span> / <span id="ptt-2024-total">0</span></p>
      <p class="text-xs text-gray-600">Used: <span id="ptt-2024-used">0</span></p>
    </div>
  </div>

  <div onclick="handleCardClick('amata-2024')" class="bag-card bg-white rounded-lg shadow-md overflow-hidden">
    <img src="https://i.ibb.co/jBfdyYY/thumbnail-IMG-8850.jpg" class="h-64 w-full object-contain bg-blue-50">
    <div class="p-4">
      <h3 class="font-semibold text-blue-700">2024 – AMATA NGD</h3>
      <div class="progress-container mt-2"><div id="amata-2024-bar" class="progress-bar w-full"></div></div>
      <p class="mt-2 text-sm">Remaining: <span id="amata-2024-remaining">0</span> / <span id="amata-2024-total">0</span></p>
      <p class="text-xs text-gray-600">Used: <span id="amata-2024-used">0</span></p>
    </div>
  </div>

  <div onclick="handleCardClick('ptt-2025')" class="bag-card bg-white rounded-lg shadow-md overflow-hidden">
    <img src="https://i.ibb.co/qFr04hHx/thumbnail-IMG-8851.jpg" class="h-64 w-full object-contain bg-blue-50">
    <div class="p-4">
      <h3 class="font-semibold text-blue-700">2025 – PTT NGD</h3>
      <div class="progress-container mt-2"><div id="ptt-2025-bar" class="progress-bar w-full"></div></div>
      <p class="mt-2 text-sm">Remaining: <span id="ptt-2025-remaining">0</span> / <span id="ptt-2025-total">0</span></p>
      <p class="text-xs text-gray-600">Used: <span id="ptt-2025-used">0</span></p>
    </div>
  </div>

  <div onclick="handleCardClick('amata-2025')" class="bag-card bg-white rounded-lg shadow-md overflow-hidden">
    <img src="https://i.ibb.co/Q3nKbZqY/thumbnail-IMG-8848.jpg" class="h-64 w-full object-contain bg-blue-50">
    <div class="p-4">
      <h3 class="font-semibold text-blue-700">2025 – AMATA NGD</h3>
      <div class="progress-container mt-2"><div id="amata-2025-bar" class="progress-bar w-full"></div></div>
      <p class="mt-2 text-sm">Remaining: <span id="amata-2025-remaining">0</span> / <span id="amata-2025-total">0</span></p>
      <p class="text-xs text-gray-600">Used: <span id="amata-2025-used">0</span></p>
    </div>
  </div>
</div>

<!-- Records -->
<h2 class="text-xl font-semibold mb-3 text-blue-800">Collection Records</h2>
<table class="min-w-full bg-white rounded shadow-md">
<thead><tr class="bg-blue-100">
  <th class="p-2">Date</th><th class="p-2">Name</th><th class="p-2">Tel</th><th class="p-2">Bags</th><th class="p-2">Signature</th>
</tr></thead>
<tbody id="recordsTableBody"></tbody>
</table>
</div>

<div id="successMessage" class="success-message fixed top-4 right-4 bg-green-100 p-4 rounded shadow">Saved!</div>

<script>
document.getElementById("date").value = new Date().toISOString().split("T")[0];
</script>
</body>
</html>
