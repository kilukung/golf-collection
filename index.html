<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, getDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDG0_qs4g4ajpoqAgSYCf_NKNwbFogQEQ",
  authDomain: "golf-collection-list.firebaseapp.com",
  projectId: "golf-collection-list",
  storageBucket: "golf-collection-list.appspot.com",
  messagingSenderId: "119781201406",
  appId: "1:119781201406:web:43499800e32cc9c5b25caf",
  measurementId: "G-E396QPZBG6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const bagsInfo = {
  "ptt-2024": {name:"2024 – PTT NGD", img:"https://i.ibb.co/HD0PLqk5/thumbnail-IMG-8849.jpg"},
  "amata-2024": {name:"2024 – AMATA NGD", img:"https://i.ibb.co/jBfdyYY/thumbnail-IMG-8850.jpg"},
  "ptt-2025": {name:"2025 – PTT NGD", img:"https://i.ibb.co/qFr04hHx/thumbnail-IMG-8851.jpg"},
  "amata-2025": {name:"2025 – AMATA NGD", img:"https://i.ibb.co/Q3nKbZqY/thumbnail-IMG-8848.jpg"}
};

const dashboard = document.getElementById("dashboard");
const form = document.getElementById("collectionForm");
const tableBody = document.getElementById("recordsTableBody");
const successMessage = document.getElementById("successMessage");
const undoBtn = document.getElementById("undoBtn");
let lastAction = null;
let selectedBags = [];

// Dark mode toggle
document.getElementById("darkToggle").addEventListener("click",()=>{
  document.documentElement.classList.toggle("dark");
});

// Render dashboard
function renderDashboard(data){
  dashboard.innerHTML="";
  Object.keys(bagsInfo).forEach(key=>{
    const inv = data[key]||{total:0,used:0,remaining:0};
    const percent = inv.total ? (inv.remaining/inv.total)*100 : 0;
    const selected = selectedBags.includes(key) ? "selected" : "";
    const disabled = inv.remaining <= 0 ? "opacity-40 cursor-not-allowed" : "cursor-pointer";
    dashboard.innerHTML += `
    <div class="bag-card ${selected} ${disabled} bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden" data-key="${key}">
      <div class="bg-accent dark:bg-gray-700 h-48 flex justify-center items-center">
        <img src="${bagsInfo[key].img}" class="h-40 object-contain"/>
      </div>
      <div class="p-4">
        <h3 class="font-semibold">${bagsInfo[key].name}</h3>
        <p>Total: ${inv.total}</p>
        <p>Used: ${inv.used}</p>
        <p class="text-primary font-bold">Remaining: ${inv.remaining}/${inv.total}</p>
        <div class="w-full bg-gray-200 h-3 rounded-full mt-2">
          <div class="h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width:${percent}%"></div>
        </div>
      </div>
    </div>`;
  });

  document.querySelectorAll(".bag-card").forEach(card=>{
    const key = card.dataset.key;
    card.addEventListener("click",()=>{
      if (card.classList.contains("cursor-not-allowed")) return;
      if(selectedBags.includes(key)){
        selectedBags = selectedBags.filter(k=>k!==key);
      } else {
        selectedBags.push(key);
      }
      renderDashboard(data);
    });
  });
}

// realtime inventory
onSnapshot(collection(db,"inventory"), snapshot=>{
  const data={};
  snapshot.forEach(doc=>data[doc.id]=doc.data());
  renderDashboard(data);
});

// load records
async function loadRecords(){
  tableBody.innerHTML="";
  const snapshot=await getDocs(collection(db,"collections"));
  snapshot.forEach(docSnap=>{
    const d=docSnap.data();
    tableBody.innerHTML += `<tr>
      <td class="p-2">${d.date}</td>
      <td class="p-2">${d.name}</td>
      <td class="p-2">${d.telephone}</td>
      <td class="p-2">${(d.bags||[]).join(", ")}</td>
      <td class="p-2">${d.signature}</td>
    </tr>`;
  });
}

// submit
form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(selectedBags.length===0){alert("Please select at least one bag.");return;}
  const date=form.querySelector("#date").value;
  const name=form.querySelector("#name").value;
  const telephone=form.querySelector("#telephone").value;
  const signature=form.querySelector("#signature").value;

  // update inventory
  for(let key of selectedBags){
    const invRef = doc(db,"inventory",key);
    const invSnap = await getDoc(invRef);
    const invData = invSnap.data();
    if(invData.remaining>0){
      await setDoc(invRef,{...invData,used:invData.used+1,remaining:invData.remaining-1});
    }
  }

  const docRef = await addDoc(collection(db,"collections"),{date,name,telephone,signature,bags:selectedBags});
  lastAction={selected:[...selectedBags], recordId:docRef.id};

  undoBtn.classList.remove("hidden");
  successMessage.classList.add("show");
  setTimeout(()=>successMessage.classList.remove("show"),2000);

  selectedBags=[];
  form.reset();
  loadRecords();
});

// undo
undoBtn.addEventListener("click",async()=>{
  if(!lastAction)return;
  // restore inventory
  for(let key of lastAction.selected){
    const invRef=doc(db,"inventory",key);
    const snap=await getDoc(invRef);
    const inv=snap.data();
    await setDoc(invRef,{...inv,used:inv.used-1,remaining:inv.remaining+1});
  }
  // delete the record
  if(lastAction.recordId){
    await deleteDoc(doc(db,"collections",lastAction.recordId));
  }

  lastAction=null;
  undoBtn.classList.add("hidden");
  loadRecords();
});

loadRecords();
</script>
